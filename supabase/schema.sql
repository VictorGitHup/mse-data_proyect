-- ------------------------------------------------------------------------------------------------
-- 1. TIPOS DE DATOS PERSONALIZADOS
-- ------------------------------------------------------------------------------------------------

-- Tipo Enum para el rol del usuario
drop type if exists public.user_role;
create type public.user_role as enum ('USER', 'ADVERTISER');

-- Tipo Enum para el estado de un anuncio
drop type if exists public.ad_status;
create type public.ad_status as enum ('active', 'inactive', 'draft', 'expired');

-- Tipo Enum para el tipo de medio de un anuncio
drop type if exists public.ad_media_type;
create type public.ad_media_type as enum ('image', 'video');

-- Tipo Enum para el estado de un comentario
drop type if exists public.comment_status;
create type public.comment_status as enum ('pending', 'approved', 'rejected');

-- ------------------------------------------------------------------------------------------------
-- 2. TABLAS
-- ------------------------------------------------------------------------------------------------

-- Tabla de Perfiles de Usuario
-- Almacena datos públicos y el rol del usuario, vinculada a `auth.users`.
create table if not exists public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  updated_at timestamp with time zone,
  username text unique,
  full_name text,
  avatar_url text,
  country_id int,
  role public.user_role,
  contact_email text,
  contact_whatsapp text,
  contact_telegram text,
  contact_social_url text,
  constraint username_length check (char_length(username) >= 3)
);

-- Tabla de Categorías
-- Almacena las categorías de los anuncios.
create table if not exists public.categories (
    id serial primary key,
    name text not null unique
);

-- Tabla de Ubicaciones
-- Almacena países, regiones y subregiones de forma jerárquica.
create table if not exists public.locations (
    id serial primary key,
    name text not null,
    type text not null, -- 'country', 'region', 'subregion'
    parent_id integer references public.locations(id),
    code varchar(10),
    phone_code text
);

-- Tabla de Anuncios
-- El corazón de la aplicación, almacena todos los anuncios.
create table if not exists public.ads (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users not null,
  title text not null,
  description text not null,
  category_id int references public.categories(id) not null,
  country_id int references public.locations(id),
  region_id int references public.locations(id),
  subregion_id int references public.locations(id),
  status public.ad_status not null default 'draft',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone,
  boosted_until timestamp with time zone,
  slug text unique not null
);
-- Añadir referencia de `country_id` de `profiles` a `locations`
alter table public.profiles add constraint profiles_country_id_fkey foreign key (country_id) references public.locations(id);


-- Tabla de Medios de Anuncios
-- Almacena las URLs de imágenes y videos para cada anuncio.
create table if not exists public.ad_media (
    id serial primary key,
    ad_id bigint references public.ads(id) on delete cascade not null,
    user_id uuid references auth.users on delete cascade not null,
    url text not null,
    type public.ad_media_type not null default 'image',
    is_cover boolean not null default false,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Tabla de Calificaciones
-- Permite a los usuarios calificar los anuncios.
create table if not exists public.ratings (
    id serial primary key,
    ad_id bigint references public.ads(id) on delete cascade not null,
    user_id uuid references auth.users on delete cascade not null,
    rating smallint not null check (rating >= 1 and rating <= 5),
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    unique(ad_id, user_id)
);

-- Tabla de Comentarios
-- Permite a los usuarios dejar comentarios en los anuncios.
create table if not exists public.comments (
    id serial primary key,
    ad_id bigint references public.ads(id) on delete cascade not null,
    user_id uuid references auth.users on delete cascade not null,
    comment text not null,
    status public.comment_status not null default 'pending',
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Tabla de Transacciones de Boost
-- Registra los pagos para destacar anuncios.
create table if not exists public.boost_transactions (
    id serial primary key,
    ad_id bigint references public.ads(id) on delete cascade not null,
    user_id uuid references auth.users on delete cascade not null,
    payment_id text not null, -- ID de la transacción del proveedor de pago
    amount decimal(10, 2) not null,
    currency varchar(3) not null,
    boost_days int not null,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ------------------------------------------------------------------------------------------------
-- 3. FUNCIONES Y TRIGGERS de Base de Datos
-- ------------------------------------------------------------------------------------------------

-- Función para manejar la creación de un nuevo usuario
-- Inserta automáticamente una fila en `public.profiles` cuando un nuevo usuario se registra.
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (id, full_name, username, role)
  values (
    new.id,
    new.raw_user_meta_data->>'full_name',
    new.raw_user_meta_data->>'username',
    (new.raw_user_meta_data->>'role')::public.user_role
  );
  return new;
end;
$$;

-- Trigger que ejecuta la función después de la inserción en `auth.users`
drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- ------------------------------------------------------------------------------------------------
-- 4. CONFIGURACIÓN DE ALMACENAMIENTO (STORAGE)
-- ------------------------------------------------------------------------------------------------

-- Bucket para avatares de usuario
insert into storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
values ('avatars', 'avatars', true, 5242880, '{"image/jpeg","image/png","image/webp"}')
on conflict (id) do nothing;

-- Bucket para imágenes y videos de anuncios
insert into storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
values ('ad_media', 'ad_media', true, 52428800, '{"image/jpeg","image/png","image/webp","video/mp4","video/quicktime"}')
on conflict (id) do nothing;

-- ------------------------------------------------------------------------------------------------
-- 5. POLÍTICAS DE SEGURIDAD (ROW LEVEL SECURITY - RLS)
-- ------------------------------------------------------------------------------------------------

-- --- Habilitar RLS en todas las tablas ---
alter table public.profiles enable row level security;
alter table public.ads enable row level security;
alter table public.ad_media enable row level security;
alter table public.categories enable row level security;
alter table public.locations enable row level security;
alter table public.ratings enable row level security;
alter table public.comments enable row level security;
alter table public.boost_transactions enable row level security;

-- --- Políticas para la tabla `profiles` ---
drop policy if exists "Public profiles are viewable by everyone." on public.profiles;
create policy "Public profiles are viewable by everyone." on public.profiles for select using (true);

drop policy if exists "Users can insert their own profile." on public.profiles;
create policy "Users can insert their own profile." on public.profiles for insert with check (auth.uid() = id);

drop policy if exists "Users can update own profile." on public.profiles;
create policy "Users can update own profile." on public.profiles for update using (auth.uid() = id);

-- --- Políticas para la tabla `categories` y `locations` ---
drop policy if exists "Categories are viewable by everyone." on public.categories;
create policy "Categories are viewable by everyone." on public.categories for select using (true);

drop policy if exists "Locations are viewable by everyone." on public.locations;
create policy "Locations are viewable by everyone." on public.locations for select using (true);
alter table public.locations add column if not exists phone_code text;


-- --- Políticas para la tabla `ads` ---
drop policy if exists "Active ads are viewable by everyone." on public.ads;
create policy "Active ads are viewable by everyone." on public.ads for select using (status = 'active');

drop policy if exists "Advertisers can view their own ads." on public.ads;
create policy "Advertisers can view their own ads." on public.ads for select using (auth.uid() = user_id);

drop policy if exists "Advertisers can create ads." on public.ads;
create policy "Advertisers can create ads." on public.ads for insert with check (
  auth.uid() = user_id and
  (select role from public.profiles where id = auth.uid()) = 'ADVERTISER'
);

drop policy if exists "Advertisers can update their own ads." on public.ads;
create policy "Advertisers can update their own ads." on public.ads for update using (auth.uid() = user_id);

drop policy if exists "Advertisers can delete their own ads." on public.ads;
create policy "Advertisers can delete their own ads." on public.ads for delete using (auth.uid() = user_id);

-- --- Políticas para la tabla `ad_media` ---
drop policy if exists "Ad media is viewable by everyone." on public.ad_media;
create policy "Ad media is viewable by everyone." on public.ad_media for select using (true);

drop policy if exists "Advertisers can insert media for their ads." on public.ad_media;
create policy "Advertisers can insert media for their ads." on public.ad_media for insert with check (
  auth.uid() = user_id and
  (select role from public.profiles where id = auth.uid()) = 'ADVERTISER'
);

drop policy if exists "Advertisers can delete media from their ads." on public.ad_media;
create policy "Advertisers can delete media from their ads." on public.ad_media for delete using (auth.uid() = user_id);

-- --- Políticas para la tabla `ratings` ---
drop policy if exists "Ratings are viewable by everyone." on public.ratings;
create policy "Ratings are viewable by everyone." on public.ratings for select using (true);

drop policy if exists "Users can create or update their own ratings." on public.ratings;
create policy "Users can create or update their own ratings." on public.ratings for all using (
  auth.uid() = user_id and
  -- Un anunciante no puede calificar su propio anuncio
  (select user_id from public.ads where id = ad_id) <> auth.uid()
) with check (
  auth.uid() = user_id and
  (select user_id from public.ads where id = ad_id) <> auth.uid()
);

-- --- Políticas para la tabla `comments` ---
drop policy if exists "Approved comments are viewable by everyone." on public.comments;
create policy "Approved comments are viewable by everyone." on public.comments for select using (status = 'approved');

drop policy if exists "Users can see their own pending/rejected comments." on public.comments;
create policy "Users can see their own pending/rejected comments." on public.comments for select using (auth.uid() = user_id);

drop policy if exists "Advertisers can see all comments on their ads." on public.comments;
create policy "Advertisers can see all comments on their ads." on public.comments for select using (
  (select user_id from public.ads where id = ad_id) = auth.uid()
);

drop policy if exists "Users can create comments." on public.comments;
create policy "Users can create comments." on public.comments for insert with check (
  auth.uid() = user_id and
  -- Un anunciante no puede comentar su propio anuncio
  (select user_id from public.ads where id = ad_id) <> auth.uid()
);

drop policy if exists "Advertisers can update status of comments on their ads." on public.comments;
create policy "Advertisers can update status of comments on their ads." on public.comments for update using (
  (select user_id from public.ads where id = ad_id) = auth.uid()
) with check (
  (select user_id from public.ads where id = ad_id) = auth.uid()
);

drop policy if exists "Users can delete their own comments." on public.comments;
create policy "Users can delete their own comments." on public.comments for delete using (user_id = auth.uid());


-- --- Políticas para el Almacenamiento `avatars` ---
drop policy if exists "Avatar images are publicly accessible." on storage.objects;
create policy "Avatar images are publicly accessible." on storage.objects for select using (bucket_id = 'avatars');

drop policy if exists "Anyone can upload an avatar." on storage.objects;
create policy "Anyone can upload an avatar." on storage.objects for insert with check (bucket_id = 'avatars');

drop policy if exists "Users can update their own avatar." on storage.objects;
create policy "Users can update their own avatar." on storage.objects for update with check (auth.uid() = owner and bucket_id = 'avatars');

-- --- Políticas para el Almacenamiento `ad_media` ---
drop policy if exists "Ad media is publicly accessible." on storage.objects;
create policy "Ad media is publicly accessible." on storage.objects for select using (bucket_id = 'ad_media');

drop policy if exists "Advertisers can upload media." on storage.objects;
create policy "Advertisers can upload media." on storage.objects for insert with check (
  bucket_id = 'ad_media' AND
  auth.uid() = owner AND
  (select role from public.profiles where id = auth.uid()) = 'ADVERTISER'
);

drop policy if exists "Advertisers can delete their own media." on storage.objects;
create policy "Advertisers can delete their own media." on storage.objects for delete using (
  bucket_id = 'ad_media' AND
  auth.uid() = owner
);

-- --- DATA INICIAL (Opcional, para desarrollo) ---
-- Puedes descomentar y personalizar esto para poblar tu base de datos con datos de prueba.

-- insert into public.categories (name) values
-- ('Scorts'),
-- ('Chicas Trans'),
-- ('Scorts Gay'),
-- ('Servicios Virtuales')
-- on conflict(name) do nothing;

-- insert into public.locations (name, type, code) values
-- ('España', 'country', 'ES')
-- on conflict do nothing;
-- insert into public.locations (name, type, parent_id) values
-- ('Madrid', 'region', (select id from public.locations where code = 'ES')),
-- ('Barcelona', 'region', (select id from public.locations where code = 'ES'))
-- on conflict do nothing;
