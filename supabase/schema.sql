
-- Tipos personalizados
drop type if exists public.user_role;
create type public.user_role as enum ('USER', 'ADVERTISER');

drop type if exists public.ad_status;
create type public.ad_status as enum ('active', 'inactive', 'draft', 'expired');

drop type if exists public.media_type;
create type public.media_type as enum ('image', 'video');

--
-- Tabla de Perfiles
--
create table if not exists public.profiles (
  id uuid references auth.users not null primary key,
  updated_at timestamp with time zone,
  username text unique,
  full_name text,
  avatar_url text,
  role user_role not null default 'USER',
  country_id int references public.locations(id),
  contact_email text,
  contact_whatsapp text,
  contact_telegram text,
  contact_social_url text,

  constraint username_length check (char_length(username) >= 3)
);

--
-- Tabla de Categorías
--
create table if not exists public.categories (
  id serial primary key,
  name text not null unique
);

--
-- Tabla de Ubicaciones
--
create table if not exists public.locations (
    id serial primary key,
    name text not null,
    type text not null, -- 'country', 'region', 'subregion'
    parent_id integer references public.locations(id),
    code varchar(10),
    phone_code varchar(10)
);
create index if not exists idx_locations_type on public.locations(type);
create index if not exists idx_locations_parent_id on public.locations(parent_id);


--
-- Tabla de Anuncios
--
create table if not exists public.ads (
  id bigint generated by default as identity primary key,
  user_id uuid not null references public.profiles,
  title text not null,
  description text,
  category_id int not null references public.categories,
  country_id int references public.locations,
  region_id int references public.locations,
  subregion_id int references public.locations,
  status ad_status not null default 'draft',
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone,
  boosted_until timestamp with time zone,
  slug text not null unique
);
create index if not exists idx_ads_user_id on public.ads(user_id);
create index if not exists idx_ads_status on public.ads(status);


--
-- Tabla de Medios del Anuncio
--
create table if not exists public.ad_media (
    id bigint generated by default as identity primary key,
    ad_id bigint not null references public.ads(id) on delete cascade,
    user_id uuid not null references public.profiles(id) on delete cascade,
    url text not null,
    type media_type not null default 'image',
    is_cover boolean not null default false,
    created_at timestamp with time zone not null default now()
);
create index if not exists idx_ad_media_ad_id on public.ad_media(ad_id);
create index if not exists idx_ad_media_user_id on public.ad_media(user_id);


--
-- Función y Trigger para crear perfil de usuario automáticamente
--
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (id, full_name, username, role)
  values (
    new.id,
    new.raw_user_meta_data->>'full_name',
    new.raw_user_meta_data->>'username',
    (new.raw_user_meta_data->>'role')::user_role
  );
  return new;
end;
$$;

drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();


--
-- Configuración de Storage
--
insert into storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
values 
    ('avatars', 'avatars', true, 5242880, '{"image/jpeg","image/png","image/webp"}'),
    ('ad_media', 'ad_media', true, 52428800, '{"image/jpeg","image/png","image/webp","video/mp4","video/quicktime"}')
on conflict (id) do nothing;


--
-- Políticas de Seguridad a Nivel de Fila (RLS)
--

-- PROFILES
alter table public.profiles enable row level security;
drop policy if exists "Public profiles are viewable by everyone." on public.profiles;
create policy "Public profiles are viewable by everyone." on public.profiles for select using (true);
drop policy if exists "Users can insert their own profile." on public.profiles;
create policy "Users can insert their own profile." on public.profiles for insert with check (auth.uid() = id);
drop policy if exists "Users can update their own profile." on public.profiles;
create policy "Users can update their own profile." on public.profiles for update using (auth.uid() = id);

-- ADS
alter table public.ads enable row level security;
drop policy if exists "Ads are viewable by everyone." on public.ads;
-- Allow read access for everyone, regardless of status. UI will show the status.
create policy "Ads are viewable by everyone." on public.ads for select using (true);

drop policy if exists "Advertisers can create ads." on public.ads;
create policy "Advertisers can create ads." on public.ads for insert with check (
  auth.uid() = user_id and
  (select role from public.profiles where id = auth.uid()) = 'ADVERTISER'
);

drop policy if exists "Advertisers can update their own ads." on public.ads;
create policy "Advertisers can update their own ads." on public.ads for update using (
  auth.uid() = user_id
) with check (
  auth.uid() = user_id
);

drop policy if exists "Advertisers can delete their own ads." on public.ads;
create policy "Advertisers can delete their own ads." on public.ads for delete using (
  auth.uid() = user_id
);


-- CATEGORIES & LOCATIONS (Tablas públicas)
alter table public.categories enable row level security;
drop policy if exists "Categories are viewable by everyone." on public.categories;
create policy "Categories are viewable by everyone." on public.categories for select using (true);

alter table public.locations enable row level security;
drop policy if exists "Locations are viewable by everyone." on public.locations;
create policy "Locations are viewable by everyone." on public.locations for select using (true);


-- AD MEDIA
alter table public.ad_media enable row level security;
drop policy if exists "Ad media is viewable by everyone." on public.ad_media;
create policy "Ad media is viewable by everyone." on public.ad_media for select using (true);

drop policy if exists "Advertisers can insert media for their ads." on public.ad_media;
create policy "Advertisers can insert media for their ads." on public.ad_media for insert with check (
  auth.uid() = user_id and
  (select role from public.profiles where id = auth.uid()) = 'ADVERTISER'
);

drop policy if exists "Advertisers can update their own media." on public.ad_media;
create policy "Advertisers can update their own media." on public.ad_media for update using (
    auth.uid() = user_id
);

drop policy if exists "Advertisers can delete their own media." on public.ad_media;
create policy "Advertisers can delete their own media." on public.ad_media for delete using (
    auth.uid() = user_id
);


-- STORAGE POLICIES

-- AVATARS
drop policy if exists "Avatar images are publicly accessible." on storage.objects;
create policy "Avatar images are publicly accessible." on storage.objects for select using ( bucket_id = 'avatars' );

drop policy if exists "Anyone can upload an avatar." on storage.objects;
create policy "Anyone can upload an avatar." on storage.objects for insert with check ( bucket_id = 'avatars' and auth.uid() is not null );

drop policy if exists "Anyone can update their own avatar." on storage.objects;
create policy "Anyone can update their own avatar." on storage.objects for update with check ( bucket_id = 'avatars' and auth.uid() = owner_id );


-- AD MEDIA
drop policy if exists "Ad media files are publicly accessible." on storage.objects;
create policy "Ad media files are publicly accessible." on storage.objects for select using ( bucket_id = 'ad_media' );

drop policy if exists "Advertisers can upload ad media." on storage.objects;
create policy "Advertisers can upload ad media." on storage.objects for insert with check ( 
    bucket_id = 'ad_media' and 
    auth.uid() is not null and
    (select role from public.profiles where id = auth.uid()) = 'ADVERTISER'
);

drop policy if exists "Advertisers can update their own ad media." on storage.objects;
create policy "Advertisers can update their own ad media." on storage.objects for update with check ( 
    bucket_id = 'ad_media' and 
    auth.uid() = owner_id
);

drop policy if exists "Advertisers can delete their own ad media." on storage.objects;
create policy "Advertisers can delete their own ad media." on storage.objects for delete using ( 
    bucket_id = 'ad_media' and 
    auth.uid() = owner_id
);

--
-- Datos iniciales (semillas)
--
-- Elimina datos existentes para evitar duplicados al re-ejecutar
delete from public.locations;
delete from public.categories;
alter sequence public.locations_id_seq restart with 1;
alter sequence public.categories_id_seq restart with 1;

-- Insertar Categorías
insert into public.categories (name) values
('Scorts'),
('Chicas Trans'),
('Scorts Gay'),
('Servicios Virtuales');

-- Insertar Ubicaciones de ejemplo
-- Países
insert into public.locations (name, type, code, phone_code) values
('Colombia', 'country', 'CO', '57'),
('España', 'country', 'ES', '34');

-- Regiones
insert into public.locations (name, type, parent_id) values
('Antioquia', 'region', (select id from public.locations where name = 'Colombia')),
('Comunidad de Madrid', 'region', (select id from public.locations where name = 'España'));

-- Ciudades/Subregiones
insert into public.locations (name, type, parent_id) values
('Medellín', 'subregion', (select id from public.locations where name = 'Antioquia')),
('Madrid', 'subregion', (select id from public.locations where name = 'Comunidad de Madrid'));

