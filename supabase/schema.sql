
-- ### GENERAL SETUP ###
-- Eliminar políticas de RLS y tipos existentes para una re-ejecución limpia
DROP POLICY IF EXISTS "Enable read access for all users" ON public.profiles;
DROP POLICY IF EXISTS "Users can insert their own profile." ON public.profiles;
DROP POLICY IF EXISTS "Users can update their own profile." ON public.profiles;
DROP POLICY IF EXISTS "Allow read access to everyone" ON public.ads;
DROP POLICY IF EXISTS "Users can insert their own ads." ON public.ads;
DROP POLICY IF EXISTS "Users can update their own ads." ON public.ads;
DROP POLICY IF EXISTS "Users can delete their own ads." ON public.ads;
DROP POLICY IF EXISTS "Allow read access to everyone" ON public.categories;
DROP POLICY IF EXISTS "Allow read access to everyone" ON public.locations;
DROP POLICY IF EXISTS "Allow read access to everyone" ON public.ratings;
DROP POLICY IF EXISTS "Allow authenticated users to insert ratings." ON public.ratings;
DROP POLICY IF EXISTS "Users can update their own rating." ON public.ratings;
DROP POLICY IF EXISTS "Allow read access to approved comments" ON public.comments;
DROP POLICY IF EXISTS "Advertisers can read their ads' comments" ON public.comments;
DROP POLICY IF EXISTS "Users can insert comments." ON public.comments;
DROP POLICY IF EXISTS "Users can delete their own comments." ON public.comments;
DROP POLICY IF EXISTS "Advertisers can update comments on their ads." ON public.comments;

-- Eliminar tablas si existen
DROP TABLE IF EXISTS public.ads;
DROP TABLE IF EXISTS public.profiles;
DROP TABLE IF EXISTS public.categories;
DROP TABLE IF EXISTS public.locations;
DROP TABLE IF EXISTS public.ratings;
DROP TABLE IF EXISTS public.comments;

-- Eliminar tipos si existen
DROP TYPE IF EXISTS public.user_role;
DROP TYPE IF EXISTS public.ad_status;
DROP TYPE IF EXISTS public.comment_status;

-- Crear tipos ENUM para roles de usuario y estado de anuncios
CREATE TYPE public.user_role AS ENUM ('USER', 'ADVERTISER');
CREATE TYPE public.ad_status AS ENUM ('active', 'inactive', 'draft', 'expired');
CREATE TYPE public.comment_status AS ENUM ('pending', 'approved', 'rejected');

-- ### TABLE: PROFILES ###
-- Almacena datos públicos del usuario y opciones de contacto
CREATE TABLE public.profiles (
    id uuid NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    updated_at timestamptz,
    username text UNIQUE,
    full_name text,
    avatar_url text,
    role public.user_role NOT NULL,
    -- Campos de contacto para anunciantes
    contact_email text,
    contact_whatsapp text,
    contact_telegram text,
    contact_social_url text,

    CONSTRAINT username_length CHECK (char_length(username) >= 3)
);
COMMENT ON TABLE public.profiles IS 'Almacena el perfil público de un usuario.';

-- ### TABLE: CATEGORIES ###
-- Tabla maestra para categorías de anuncios
CREATE TABLE public.categories (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL UNIQUE
);
COMMENT ON TABLE public.categories IS 'Almacena las categorías de los anuncios.';

-- ### TABLE: LOCATIONS ###
-- Tabla maestra para ubicaciones geográficas
CREATE TABLE public.locations (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL,
    type text NOT NULL, -- 'country', 'region', 'subregion'
    parent_id bigint REFERENCES public.locations(id),
    code text
);
COMMENT ON TABLE public.locations IS 'Almacena las ubicaciones geográficas.';

-- ### TABLE: ADS ###
-- Tabla principal para los anuncios
CREATE TABLE public.ads (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    title text NOT NULL,
    description text,
    category_id bigint NOT NULL REFERENCES public.categories(id),
    country_id bigint NOT NULL REFERENCES public.locations(id),
    region_id bigint NOT NULL REFERENCES public.locations(id),
    subregion_id bigint REFERENCES public.locations(id),
    image_url text,
    video_url text,
    slug text UNIQUE,
    status public.ad_status DEFAULT 'draft',
    created_at timestamptz DEFAULT timezone('utc'::text, now()),
    updated_at timestamptz
);
COMMENT ON TABLE public.ads IS 'Almacena los anuncios publicados por los usuarios.';
-- Crear índice en user_id para búsquedas rápidas
CREATE INDEX ads_user_id_idx ON public.ads(user_id);


-- ### TABLE: RATINGS ###
-- Almacena las calificaciones de los anuncios
CREATE TABLE public.ratings (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad_id bigint NOT NULL REFERENCES public.ads(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    rating smallint NOT NULL,
    created_at timestamptz DEFAULT timezone('utc'::text, now()),
    UNIQUE (ad_id, user_id), -- Un usuario solo puede calificar un anuncio una vez
    CONSTRAINT rating_check CHECK (rating >= 1 AND rating <= 5)
);
COMMENT ON TABLE public.ratings IS 'Almacena las calificaciones de los anuncios.';

-- ### TABLE: COMMENTS ###
-- Almacena los comentarios de los anuncios
CREATE TABLE public.comments (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad_id bigint NOT NULL REFERENCES public.ads(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    content text NOT NULL,
    status public.comment_status DEFAULT 'pending',
    created_at timestamptz DEFAULT timezone('utc'::text, now())
);
COMMENT ON TABLE public.comments IS 'Almacena los comentarios en los anuncios.';


-- ### AUTOMATION: NEW USER TRIGGER ###
-- Función para insertar una fila en public.profiles al crear un usuario en auth.users
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, username, role)
  VALUES (
    new.id,
    new.raw_user_meta_data->>'full_name',
    new.raw_user_meta_data->>'username',
    (new.raw_user_meta_data->>'role')::public.user_role
  );
  RETURN new;
END;
$$;

-- Trigger que ejecuta la función cada vez que se crea un usuario
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- ### STORAGE SETUP ###
-- Crear buckets para avatares e imágenes/videos de anuncios
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true)
ON CONFLICT (id) DO NOTHING;

INSERT INTO storage.buckets (id, name, public)
VALUES ('ad_images', 'ad_images', true)
ON CONFLICT (id) DO NOTHING;

INSERT INTO storage.buckets (id, name, public)
VALUES ('ad_videos', 'ad_videos', true)
ON CONFLICT (id) DO NOTHING;


-- ### SECURITY POLICIES (RLS) ###
-- Activar Row Level Security para todas las tablas
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.locations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ratings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;

-- Políticas para `profiles`
CREATE POLICY "Enable read access for all users" ON public.profiles FOR SELECT USING (true);
CREATE POLICY "Users can insert their own profile." ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update their own profile." ON publicľad.profiles FOR UPDATE USING (auth.uid() = id);

-- Políticas para `ads`
CREATE POLICY "Allow read access to everyone" ON public.ads FOR SELECT USING (status = 'active');
CREATE POLICY "Users can insert their own ads." ON public.ads FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own ads." ON public.ads FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own ads." ON public.ads FOR DELETE USING (auth.uid() = user_id);

-- Políticas para tablas maestras `categories` y `locations` (solo lectura para todos)
CREATE POLICY "Allow read access to everyone" ON public.categories FOR SELECT USING (true);
CREATE POLICY "Allow read access to everyone" ON public.locations FOR SELECT USING (true);

-- Políticas para `ratings`
CREATE POLICY "Allow read access to everyone" ON public.ratings FOR SELECT USING (true);
CREATE POLICY "Allow authenticated users to insert ratings." ON public.ratings FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Users can update their own rating." ON public.ratings FOR UPDATE USING (auth.uid() = user_id);

-- Políticas para `comments`
CREATE POLICY "Allow read access to approved comments" ON public.comments FOR SELECT USING (status = 'approved');
CREATE POLICY "Advertisers can read their ads' comments" ON public.comments FOR SELECT USING (
    (SELECT user_id FROM public.ads WHERE id = ad_id) = auth.uid()
);
CREATE POLICY "Users can insert comments." ON public.comments FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Users can delete their own comments." ON public.comments FOR DELETE USING (auth.uid() = user_id);
CREATE POLICY "Advertisers can update comments on their ads." ON public.comments FOR UPDATE USING (
    (SELECT user_id FROM public.ads WHERE id = ad_id) = auth.uid()
);


-- Políticas para `storage.objects` (avatares, imágenes y videos de anuncios)
-- Permisos para el bucket 'avatars'
CREATE POLICY "Allow public read access to avatars" ON storage.objects FOR SELECT USING ( bucket_id = 'avatars' );
CREATE POLICY "Allow authenticated user to upload avatar" ON storage.objects FOR INSERT WITH CHECK ( bucket_id = 'avatars' AND auth.role() = 'authenticated' );
CREATE POLICY "Allow user to update their own avatar" ON storage.objects FOR UPDATE USING ( bucket_id = 'avatars' AND auth.uid() = owner ) WITH CHECK ( auth.uid() = owner );

-- Permisos para el bucket 'ad_images'
CREATE POLICY "Allow public read access to ad images" ON storage.objects FOR SELECT USING ( bucket_id = 'ad_images' );
CREATE POLICY "Allow advertiser to upload ad images" ON storage.objects FOR INSERT WITH CHECK ( bucket_id = 'ad_images' AND (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'ADVERTISER' );
CREATE POLICY "Allow advertiser to update their own ad images" ON storage.objects FOR UPDATE USING ( bucket_id = 'ad_images' AND auth.uid() = owner ) WITH CHECK ( auth.uid() = owner );
CREATE POLICY "Allow advertiser to delete their own ad images" ON storage.objects FOR DELETE USING ( bucket_id = 'ad_images' AND auth.uid() = owner );

-- Permisos para el bucket 'ad_videos'
CREATE POLICY "Allow public read access to ad videos" ON storage.objects FOR SELECT USING ( bucket_id = 'ad_videos' );
CREATE POLICY "Allow advertiser to upload ad videos" ON storage.objects FOR INSERT WITH CHECK ( bucket_id = 'ad_videos' AND (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'ADVERTISER' );
CREATE POLICY "Allow advertiser to update their own ad videos" ON storage.objects FOR UPDATE USING ( bucket_id = 'ad_videos' AND auth.uid() = owner ) WITH CHECK ( auth.uid() = owner );
CREATE POLICY "Allow advertiser to delete their own ad videos" ON storage.objects FOR DELETE USING ( bucket_id = 'ad_videos' AND auth.uid() = owner );

    