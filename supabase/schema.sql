-- ------------------------------------------------
--          TIPOS PERSONALIZADOS (ENUMS)
-- ------------------------------------------------

-- Roles de Usuario
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'user_role') THEN
        CREATE TYPE public.user_role AS ENUM ('USER', 'ADVERTISER');
    END IF;
END$$;

-- Estados de Anuncio
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'ad_status') THEN
        CREATE TYPE public.ad_status AS ENUM ('active', 'inactive', 'draft', 'expired');
    END IF;
END$$;

-- Tipos de Media
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'media_type') THEN
        CREATE TYPE public.media_type AS ENUM ('image', 'video');
    END IF;
END$$;

-- ------------------------------------------------
--                TABLA DE PERFILES
-- ------------------------------------------------

CREATE TABLE IF NOT EXISTS public.profiles (
  id uuid NOT NULL PRIMARY KEY,
  updated_at timestamptz,
  username text UNIQUE,
  full_name text,
  avatar_url text,
  role user_role,
  country_id int,
  contact_email text,
  contact_whatsapp text,
  contact_telegram text,
  contact_social_url text,

  CONSTRAINT username_length CHECK (char_length(username) >= 3),
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE
);

-- ------------------------------------------------
--            TABLAS MAESTRAS (CATALOGOS)
-- ------------------------------------------------

-- Tabla de Categorías
CREATE TABLE IF NOT EXISTS public.categories (
    id SERIAL PRIMARY KEY,
    name text NOT NULL UNIQUE
);

-- Tabla de Ubicaciones (País, Región, Ciudad)
CREATE TABLE IF NOT EXISTS public.locations (
    id SERIAL PRIMARY KEY,
    name text NOT NULL,
    type text NOT NULL, -- 'country', 'region', 'subregion'
    parent_id integer REFERENCES public.locations(id),
    code varchar(10), -- 'ES', 'CO', etc.
    phone_code varchar(10) -- '34', '57', etc.
);

-- ------------------------------------------------
--                TABLA DE ANUNCIOS
-- ------------------------------------------------

CREATE TABLE IF NOT EXISTS public.ads (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid NOT NULL,
  title text NOT NULL,
  description text NOT NULL,
  category_id integer NOT NULL,
  country_id integer,
  region_id integer,
  subregion_id integer,
  status ad_status DEFAULT 'draft',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz,
  boosted_until timestamptz,
  slug text UNIQUE,

  CONSTRAINT ads_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE,
  CONSTRAINT ads_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id),
  CONSTRAINT ads_country_id_fkey FOREIGN KEY (country_id) REFERENCES public.locations(id),
  CONSTRAINT ads_region_id_fkey FOREIGN KEY (region_id) REFERENCES public.locations(id),
  CONSTRAINT ads_subregion_id_fkey FOREIGN KEY (subregion_id) REFERENCES public.locations(id)
);


-- ------------------------------------------------
--             TABLA DE MEDIA (IMAGEN/VIDEO)
-- ------------------------------------------------

CREATE TABLE IF NOT EXISTS public.ad_media (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad_id bigint NOT NULL,
    user_id uuid NOT NULL,
    url text NOT NULL,
    type media_type NOT NULL,
    is_cover boolean DEFAULT false,
    created_at timestamptz DEFAULT now(),

    CONSTRAINT ad_media_ad_id_fkey FOREIGN KEY (ad_id) REFERENCES public.ads(id) ON DELETE CASCADE,
    CONSTRAINT ad_media_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE
);


-- ------------------------------------------------
--         FUNCIÓN Y TRIGGER PARA NUEVOS USUARIOS
-- ------------------------------------------------

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, username, role)
  VALUES (
    new.id,
    new.raw_user_meta_data->>'full_name',
    new.raw_user_meta_data->>'username',
    (new.raw_user_meta_data->>'role')::user_role
  );
  RETURN new;
END;
$$;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- ------------------------------------------------
--                CONFIGURACIÓN DE STORAGE
-- ------------------------------------------------

-- Bucket para avatares
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true)
ON CONFLICT (id) DO NOTHING;

-- Bucket para media de anuncios
INSERT INTO storage.buckets (id, name, public)
VALUES ('ad_media', 'ad_media', true)
ON CONFLICT (id) DO NOTHING;


-- ------------------------------------------------
--           POLÍTICAS DE SEGURIDAD (RLS)
-- ------------------------------------------------

-- Habilitar RLS en todas las tablas
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.locations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ad_media ENABLE ROW LEVEL SECURITY;

-- Políticas para `profiles`
DROP POLICY IF EXISTS "Public profiles are viewable by everyone." ON public.profiles;
CREATE POLICY "Public profiles are viewable by everyone."
ON public.profiles FOR SELECT
TO public
USING (true);

DROP POLICY IF EXISTS "Users can insert their own profile." ON public.profiles;
CREATE POLICY "Users can insert their own profile."
ON public.profiles FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = id);

DROP POLICY IF EXISTS "Users can update their own profile." ON public.profiles;
CREATE POLICY "Users can update their own profile."
ON public.profiles FOR UPDATE
TO authenticated
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- Políticas para `categories` y `locations` (Solo lectura para todos)
DROP POLICY IF EXISTS "Categories are viewable by everyone." ON public.categories;
CREATE POLICY "Categories are viewable by everyone."
ON public.categories FOR SELECT
TO public
USING (true);

DROP POLICY IF EXISTS "Locations are viewable by everyone." ON public.locations;
CREATE POLICY "Locations are viewable by everyone."
ON public.locations FOR SELECT
TO public
USING (true);

-- Políticas para `ads`
DROP POLICY IF EXISTS "Ads are viewable by everyone" ON public.ads;
CREATE POLICY "Ads are viewable by everyone"
ON public.ads FOR SELECT
TO public
USING (true);

DROP POLICY IF EXISTS "Advertisers can create ads." ON public.ads;
CREATE POLICY "Advertisers can create ads."
ON public.ads FOR INSERT
TO authenticated
WITH CHECK ((auth.uid() = user_id) AND ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'ADVERTISER'));

DROP POLICY IF EXISTS "Advertisers can update their own ads." ON public.ads;
CREATE POLICY "Advertisers can update their own ads."
ON public.ads FOR UPDATE
TO authenticated
USING ((auth.uid() = user_id))
WITH CHECK ((auth.uid() = user_id));

DROP POLICY IF EXISTS "Advertisers can delete their own ads." ON public.ads;
CREATE POLICY "Advertisers can delete their own ads."
ON public.ads FOR DELETE
TO authenticated
USING (auth.uid() = user_id);

-- Políticas para `ad_media`
DROP POLICY IF EXISTS "Media is viewable by everyone." ON public.ad_media;
CREATE POLICY "Media is viewable by everyone."
ON public.ad_media FOR SELECT
TO public
USING (true);

DROP POLICY IF EXISTS "Advertisers can insert media for their ads." ON public.ad_media;
CREATE POLICY "Advertisers can insert media for their ads."
ON public.ad_media FOR INSERT
TO authenticated
WITH CHECK ((auth.uid() = user_id) AND (EXISTS (SELECT 1 FROM ads WHERE ads.id = ad_media.ad_id AND ads.user_id = auth.uid())));

DROP POLICY IF EXISTS "Advertisers can delete media from their ads." ON public.ad_media;
CREATE POLICY "Advertisers can delete media from their ads."
ON public.ad_media FOR DELETE
TO authenticated
USING (auth.uid() = user_id);


-- Políticas para `storage.objects` (Buckets)
DROP POLICY IF EXISTS "Avatar images are publicly accessible." ON storage.objects;
CREATE POLICY "Avatar images are publicly accessible."
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'avatars');

DROP POLICY IF EXISTS "Anyone can upload an avatar." ON storage.objects;
CREATE POLICY "Anyone can upload an avatar."
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'avatars');

DROP POLICY IF EXISTS "Users can update their own avatar." ON storage.objects;
CREATE POLICY "Users can update their own avatar."
ON storage.objects FOR UPDATE
TO authenticated
USING (auth.uid() = owner)
WITH CHECK (bucket_id = 'avatars');

DROP POLICY IF EXISTS "Ad media is publicly accessible." ON storage.objects;
CREATE POLICY "Ad media is publicly accessible."
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'ad_media');

DROP POLICY IF EXISTS "Advertisers can upload ad media." ON storage.objects;
CREATE POLICY "Advertisers can upload ad media."
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'ad_media' AND (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'ADVERTISER');

DROP POLICY IF EXISTS "Advertisers can delete their own ad media." ON storage.objects;
CREATE POLICY "Advertisers can delete their own ad media."
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'ad_media' AND auth.uid() = owner);

-- ------------------------------------------------
--           DATOS INICIALES (SEMILLAS)
-- ------------------------------------------------
-- Insertar categorías si no existen
INSERT INTO public.categories (name) VALUES ('Scorts'), ('Chicas Trans'), ('Scorts Gay'), ('Servicios Virtuales') ON CONFLICT (name) DO NOTHING;

-- Insertar ubicaciones de ejemplo
-- Países
INSERT INTO public.locations (name, type, code, phone_code) VALUES
('Colombia', 'country', 'CO', '57'),
('España', 'country', 'ES', '34')
ON CONFLICT DO NOTHING;

-- Regiones/Provincias
DO $$
DECLARE
    colombia_id int;
    espana_id int;
BEGIN
    SELECT id INTO colombia_id FROM public.locations WHERE name = 'Colombia' AND type = 'country';
    SELECT id INTO espana_id FROM public.locations WHERE name = 'España' AND type = 'country';

    IF colombia_id IS NOT NULL THEN
        INSERT INTO public.locations (name, type, parent_id) VALUES
        ('Antioquia', 'region', colombia_id),
        ('Cundinamarca', 'region', colombia_id);
    END IF;

    IF espana_id IS NOT NULL THEN
        INSERT INTO public.locations (name, type, parent_id) VALUES
        ('Comunidad de Madrid', 'region', espana_id),
        ('Cataluña', 'region', espana_id);
    END IF;
END$$;

-- Subregiones/Ciudades
DO $$
DECLARE
    antioquia_id int;
    madrid_region_id int;
BEGIN
    SELECT id INTO antioquia_id FROM public.locations WHERE name = 'Antioquia';
    SELECT id INTO madrid_region_id FROM public.locations WHERE name = 'Comunidad de Madrid';

    IF antioquia_id IS NOT NULL THEN
        INSERT INTO public.locations (name, type, parent_id) VALUES
        ('Medellín', 'subregion', antioquia_id),
        ('Envigado', 'subregion', antioquia_id);
    END IF;

    IF madrid_region_id IS NOT NULL THEN
        INSERT INTO public.locations (name, type, parent_id) VALUES
        ('Madrid', 'subregion', madrid_region_id);
    END IF;
END$$;
