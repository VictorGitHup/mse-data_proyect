-- Crear tipos ENUM para roles y estados
create type public.user_role as enum ('USER', 'ADVERTISER');
create type public.ad_status as enum ('active', 'inactive', 'draft', 'expired');
create type public.comment_status as enum ('pending', 'approved', 'rejected');
create type public.media_type as enum ('image', 'video');

--
-- TABLA: Perfiles de Usuario (public.profiles)
-- Almacena información pública y roles de los usuarios.
--
create table public.profiles (
  id uuid not null primary key references auth.users on delete cascade,
  updated_at timestamptz,
  username text not null unique,
  full_name text,
  avatar_url text,
  role user_role not null,
  country_id integer references public.locations(id) on delete set null,
  contact_email text,
  contact_whatsapp text,
  contact_telegram text,
  contact_social_url text,

  constraint username_length check (char_length(username) >= 3)
);
-- Políticas de Seguridad para Perfiles
alter table public.profiles enable row level security;
create policy "Los perfiles públicos son visibles para todos." on public.profiles for select using (true);
create policy "Los usuarios pueden insertar sus propios perfiles." on public.profiles for insert with check (auth.uid() = id);
create policy "Los usuarios pueden actualizar sus propios perfiles." on public.profiles for update using (auth.uid() = id);


--
-- TABLA: Categorías (public.categories)
-- Almacena las categorías de los anuncios.
--
create table public.categories (
  id integer generated by default as identity primary key,
  name text not null,
  slug text not null unique
);
-- Políticas de Seguridad para Categorías
alter table public.categories enable row level security;
create policy "Las categorías son visibles para todos." on public.categories for select using (true);


--
-- TABLA: Ubicaciones (public.locations)
-- Almacena países, regiones y subregiones.
--
create table public.locations (
  id integer generated by default as identity primary key,
  name text not null,
  type text not null, -- 'country', 'region', 'subregion'
  parent_id integer references public.locations(id),
  phone_code text, -- Solo para países
  slug text not null unique
);
-- Políticas de Seguridad para Ubicaciones
alter table public.locations enable row level security;
create policy "Las ubicaciones son visibles para todos." on public.locations for select using (true);

--
-- TABLA: Anuncios (public.ads)
-- Almacena todos los anuncios creados por los anunciantes.
--
create table public.ads (
  id bigint generated by default as identity primary key,
  user_id uuid not null references public.profiles on delete cascade,
  title text not null,
  description text not null,
  category_id integer not null references public.categories on delete cascade,
  country_id integer references public.locations on delete set null,
  region_id integer references public.locations on delete set null,
  subregion_id integer references public.locations on delete set null,
  status ad_status not null default 'draft',
  created_at timestamptz not null default now(),
  updated_at timestamptz,
  boosted_until timestamptz,
  slug text not null unique,
  tags text[],
  view_count bigint not null default 0,
  contact_click_count bigint not null default 0,

  constraint fk_country foreign key (country_id) references locations(id),
  constraint fk_region foreign key (region_id) references locations(id),
  constraint fk_subregion foreign key (subregion_id) references locations(id)
);
-- Índices para mejorar rendimiento de búsquedas
create index idx_ads_status on public.ads (status);
create index idx_ads_user_id on public.ads (user_id);
create index idx_ads_location on public.ads (country_id, region_id, subregion_id);

-- Políticas de Seguridad para Anuncios
alter table public.ads enable row level security;
create policy "Los anuncios activos son visibles para todos." on public.ads for select using (status = 'active');
create policy "Los anunciantes pueden ver sus propios anuncios." on public.ads for select using (auth.uid() = user_id);
create policy "Los anunciantes pueden crear anuncios." on public.ads for insert with check (auth.uid() = user_id);
create policy "Los anunciantes pueden actualizar sus propios anuncios." on public.ads for update using (auth.uid() = user_id);
create policy "Los anunciantes pueden eliminar sus propios anuncios." on public.ads for delete using (auth.uid() = user_id);


--
-- TABLA: Multimedia del Anuncio (public.ad_media)
-- Almacena imágenes y videos asociados a un anuncio.
--
create table public.ad_media (
  id bigint generated by default as identity primary key,
  ad_id bigint not null references public.ads on delete cascade,
  user_id uuid not null references public.profiles on delete cascade,
  url text not null,
  type media_type not null default 'image',
  is_cover boolean not null default false,
  created_at timestamptz not null default now()
);
-- Políticas de Seguridad para Multimedia
alter table public.ad_media enable row level security;
create policy "Los archivos multimedia son visibles para todos." on public.ad_media for select using (true);
create policy "Los anunciantes pueden subir multimedia para sus anuncios." on public.ad_media for insert with check (auth.uid() = user_id);
create policy "Los anunciantes pueden actualizar la multimedia de sus anuncios." on public.ad_media for update using (auth.uid() = user_id);
create policy "Los anunciantes pueden eliminar la multimedia de sus anuncios." on public.ad_media for delete using (auth.uid() = user_id);


--
-- TABLA: Calificaciones de Anuncios (public.ad_ratings)
-- Almacena las calificaciones (1-5 estrellas) que los usuarios dan a los anuncios.
--
create table public.ad_ratings (
  id bigint generated by default as identity primary key,
  ad_id bigint not null references public.ads on delete cascade,
  user_id uuid not null references auth.users on delete cascade,
  rating smallint not null check (rating >= 1 and rating <= 5),
  created_at timestamptz not null default now(),
  unique (ad_id, user_id),
  constraint cant_rate_own_ad check (user_id <> (select user_id from ads where id = ad_id))
);
-- Políticas de Seguridad para Calificaciones
alter table public.ad_ratings enable row level security;
create policy "Las calificaciones son visibles para todos." on public.ad_ratings for select using (true);
create policy "Los usuarios pueden insertar/actualizar sus propias calificaciones." on public.ad_ratings for all using (auth.uid() = user_id);


--
-- TABLA: Comentarios de Anuncios (public.ad_comments)
-- Almacena los comentarios que los usuarios dejan en los anuncios.
--
create table public.ad_comments (
  id bigint generated by default as identity primary key,
  ad_id bigint not null references public.ads on delete cascade,
  user_id uuid not null references auth.users on delete cascade,
  comment text not null,
  status comment_status not null default 'pending',
  created_at timestamptz not null default now(),
  constraint cant_comment_own_ad check (user_id <> (select user_id from ads where id = ad_id))
);
-- Políticas de Seguridad para Comentarios
alter table public.ad_comments enable row level security;
create policy "Los comentarios aprobados son visibles para todos." on public.ad_comments for select using (status = 'approved');
create policy "Los usuarios pueden ver sus propios comentarios pendientes/rechazados." on public.ad_comments for select using (auth.uid() = user_id);
create policy "El dueño del anuncio puede ver todos los comentarios en su anuncio." on public.ad_comments for select using (exists (select 1 from ads where ads.id = ad_comments.ad_id and ads.user_id = auth.uid()));
create policy "Los usuarios autenticados pueden comentar." on public.ad_comments for insert with check (auth.role() = 'authenticated');
create policy "El dueño del anuncio puede moderar los comentarios." on public.ad_comments for update using (exists (select 1 from ads where ads.id = ad_comments.ad_id and ads.user_id = auth.uid())) with check (status in ('approved', 'rejected'));
create policy "Los usuarios pueden eliminar sus propios comentarios." on public.ad_comments for delete using (auth.uid() = user_id);


--
-- VISTA: ads_with_ratings
-- Vista que pre-calcula el promedio y conteo de calificaciones para los anuncios.
--
create or replace view public.ads_with_ratings as
select
  a.*,
  coalesce(r.avg_rating, 0) as avg_rating,
  coalesce(r.rating_count, 0) as rating_count
from
  public.ads a
left join (
  select
    ad_id,
    avg(rating) as avg_rating,
    count(id) as rating_count
  from
    public.ad_ratings
  group by
    ad_id
) r on a.id = r.ad_id;

--
-- FUNCIÓN y TRIGGER: Creación automática de perfiles
--
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (id, full_name, username, role)
  values (
    new.id,
    new.raw_user_meta_data->>'full_name',
    new.raw_user_meta_data->>'username',
    (new.raw_user_meta_data->>'role')::user_role
  );
  return new;
end;
$$;
-- Trigger
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();


--
-- FUNCIONES RPC para Estadísticas
--

-- Función para incrementar vistas de un anuncio
create or replace function public.increment_ad_view(ad_id_to_inc bigint)
returns void
language plpgsql
as $$
begin
  update public.ads
  set view_count = view_count + 1
  where id = ad_id_to_inc;
end;
$$;

-- Función para incrementar clics de contacto de un anuncio
create or replace function public.increment_ad_contact_click(ad_id_to_inc bigint)
returns void
language plpgsql
as $$
begin
  update public.ads
  set contact_click_count = contact_click_count + 1
  where id = ad_id_to_inc;
end;
$$;


--
-- ALMACENAMIENTO (Storage)
--
-- Bucket para avatares de usuario
insert into storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
values ('avatars', 'avatars', true, 1048576, '{"image/jpeg","image/png","image/webp"}')
on conflict (id) do nothing;

-- Bucket para imágenes y videos de anuncios
insert into storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
values ('ad_media', 'ad_media', true, 52428800, '{"image/jpeg","image/png","image/webp","video/mp4","video/quicktime"}')
on conflict (id) do nothing;

-- Políticas de Seguridad para Avatares
create policy "Los avatares son públicos." on storage.objects for select using (bucket_id = 'avatars');
create policy "Cualquier usuario autenticado puede subir un avatar." on storage.objects for insert with check (bucket_id = 'avatars' and auth.role() = 'authenticated');
create policy "Los usuarios pueden actualizar su propio avatar." on storage.objects for update using (bucket_id = 'avatars' and auth.uid() = owner) with check (auth.uid() = owner);

-- Políticas de Seguridad para Multimedia de Anuncios
create policy "Los archivos de anuncios son públicos." on storage.objects for select using (bucket_id = 'ad_media');
create policy "Los anunciantes pueden subir archivos para sus anuncios." on storage.objects for insert with check (bucket_id = 'ad_media' and auth.uid() = (select user_id from public.ads where id = (regexp_split_to_array(name, '/'))[2]::bigint));
create policy "Los anunciantes pueden actualizar los archivos de sus anuncios." on storage.objects for update using (bucket_id = 'ad_media' and auth.uid() = owner) with check (auth.uid() = owner);
create policy "Los anunciantes pueden eliminar los archivos de sus anuncios." on storage.objects for delete using (bucket_id = 'ad_media' and auth.uid() = owner);
