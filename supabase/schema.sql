
-- =================================================================
-- HABILITAR EXTENSIONES (si aún no están habilitadas)
-- =================================================================
-- CREATE EXTENSION IF NOT EXISTS "uuid-ossp";


-- =================================================================
-- DEFINICIÓN DE TIPOS PERSONALIZADOS (ENUMS)
-- =================================================================
-- Eliminar tipos existentes si es necesario para modificaciones
DROP TYPE IF EXISTS public.user_role;
DROP TYPE IF EXISTS public.ad_status;
DROP TYPE IF EXISTS public.media_type;
DROP TYPE IF EXISTS public.comment_status;

-- Rol de usuario en la plataforma
CREATE TYPE public.user_role AS ENUM (
    'USER',
    'ADVERTISER'
);

-- Estado de un anuncio
CREATE TYPE public.ad_status AS ENUM (
    'active',
    'inactive',
    'draft',
    'expired'
);

-- Tipo de archivo multimedia
CREATE TYPE public.media_type AS ENUM (
    'image',
    'video'
);

-- Estado de un comentario para moderación
CREATE TYPE public.comment_status AS ENUM (
    'pending',
    'approved',
    'rejected'
);


-- =================================================================
-- CREACIÓN DE TABLAS
-- =================================================================

-- Tabla de perfiles de usuario
-- Almacena datos públicos y el rol del usuario.
CREATE TABLE public.profiles (
    id uuid NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    username text UNIQUE NOT NULL CHECK (char_length(username) >= 3 AND char_length(username) <= 50 AND username ~ '^[a-zA-Z0-9_]+$'),
    full_name text CHECK (char_length(full_name) >= 2 AND char_length(full_name) <= 100),
    avatar_url text,
    role user_role NOT NULL DEFAULT 'USER',
    updated_at timestamptz,
    -- Campos de contacto para anunciantes
    country_id int, -- FK se añade más abajo
    contact_email text,
    contact_whatsapp text,
    contact_telegram text,
    contact_social_url text
);

-- Tabla de categorías para los anuncios
CREATE TABLE public.categories (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL UNIQUE
);

-- Tabla de ubicaciones (países, regiones, ciudades)
CREATE TABLE public.locations (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL,
    type text NOT NULL CHECK (type IN ('country', 'region', 'subregion')),
    parent_id int REFERENCES public.locations(id),
    code varchar(10), -- ej. ISO 3166-1 alpha-2 para países
    phone_code varchar(10) -- ej. +34 para España
);

-- Añadir FK de profiles a locations
ALTER TABLE public.profiles
ADD CONSTRAINT fk_profiles_country
FOREIGN KEY (country_id) REFERENCES public.locations(id);


-- Tabla principal de anuncios
CREATE TABLE public.ads (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    title text NOT NULL,
    description text,
    category_id int REFERENCES public.categories(id),
    country_id int REFERENCES public.locations(id),
    region_id int REFERENCES public.locations(id),
    subregion_id int REFERENCES public.locations(id),
    status ad_status NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz,
    boosted_until timestamptz, -- Para anuncios potenciados
    slug text UNIQUE NOT NULL
);

-- Tabla para imágenes y videos de los anuncios
CREATE TABLE public.ad_media (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad_id bigint NOT NULL REFERENCES public.ads(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    url text NOT NULL,
    type media_type NOT NULL DEFAULT 'image',
    is_cover boolean NOT NULL DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now()
);

-- Tabla para calificaciones de anuncios
CREATE TABLE public.ad_ratings (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad_id bigint NOT NULL REFERENCES public.ads(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz,
    UNIQUE (ad_id, user_id) -- Un usuario solo puede calificar un anuncio una vez
);

-- Tabla para comentarios en anuncios
CREATE TABLE public.ad_comments (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ad_id bigint NOT NULL REFERENCES public.ads(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    comment text NOT NULL,
    status comment_status NOT NULL DEFAULT 'pending',
    parent_comment_id bigint REFERENCES public.ad_comments(id) ON DELETE CASCADE, -- Para respuestas
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz
);


-- =================================================================
-- DATOS INICIALES (SEMILLAS)
-- =================================================================
INSERT INTO public.categories(name) VALUES
('Scorts'),
('Chicas Trans'),
('Scorts Gay'),
('Servicios Virtuales');

-- Insertar países
INSERT INTO public.locations (id, name, type, code, phone_code) VALUES
(1, 'Colombia', 'country', 'CO', '57'),
(2, 'España', 'country', 'ES', '34')
ON CONFLICT (id) DO NOTHING;

-- Insertar regiones
INSERT INTO public.locations (id, name, type, parent_id) VALUES
(101, 'Antioquia', 'region', 1),
(201, 'Comunidad de Madrid', 'region', 2)
ON CONFLICT (id) DO NOTHING;

-- Insertar subregiones/ciudades
INSERT INTO public.locations (id, name, type, parent_id) VALUES
(10101, 'Medellín', 'subregion', 101),
(20101, 'Madrid', 'subregion', 201)
ON CONFLICT (id) DO NOTHING;

-- Reiniciar la secuencia para que los nuevos IDs no colisionen
SELECT setval('public.locations_id_seq', (SELECT MAX(id) FROM public.locations));


-- =================================================================
-- AUTOMATIZACIÓN (FUNCIONES Y TRIGGERS)
-- =================================================================

-- Función para crear un perfil cuando un usuario se registra
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, username, role)
  VALUES (
    new.id,
    new.raw_user_meta_data->>'full_name',
    new.raw_user_meta_data->>'username',
    (new.raw_user_meta_data->>'role')::user_role
  );
  RETURN new;
END;
$$;

-- Trigger que ejecuta la función al crear un usuario en auth.users
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();


-- =================================================================
-- CONFIGURACIÓN DE ALMACENAMIENTO (STORAGE)
-- =================================================================

-- Bucket para avatares de usuario
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true)
ON CONFLICT (id) DO NOTHING;

-- Bucket para imágenes y videos de anuncios
INSERT INTO storage.buckets (id, name, public)
VALUES ('ad_media', 'ad_media', true)
ON CONFLICT (id) DO NOTHING;


-- =================================================================
-- POLÍTICAS DE SEGURIDAD A NIVEL DE FILA (RLS)
-- =================================================================

-- --- Tabla PROFILES ---
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Profiles are viewable by everyone." ON public.profiles;
DROP POLICY IF EXISTS "Users can insert their own profile." ON public.profiles;
DROP POLICY IF EXISTS "Users can update their own profile." ON public.profiles;

CREATE POLICY "Profiles are viewable by everyone."
ON public.profiles FOR SELECT
USING (true);

CREATE POLICY "Users can insert their own profile."
ON public.profiles FOR INSERT
WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update their own profile."
ON public.profiles FOR UPDATE
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- --- Tabla LOCATIONS y CATEGORIES (datos públicos) ---
ALTER TABLE public.locations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Locations are viewable by everyone." ON public.locations;
DROP POLICY IF EXISTS "Categories are viewable by everyone." ON public.categories;

CREATE POLICY "Locations are viewable by everyone."
ON public.locations FOR SELECT USING (true);

CREATE POLICY "Categories are viewable by everyone."
ON public.categories FOR SELECT USING (true);

-- --- Tabla ADS ---
ALTER TABLE public.ads ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Ads are viewable by everyone." ON public.ads;
DROP POLICY IF EXISTS "Advertisers can insert their own ads." ON public.ads;
DROP POLICY IF EXISTS "Advertisers can update their own ads." ON public.ads;
DROP POLICY IF EXISTS "Advertisers can delete their own ads." ON public.ads;

CREATE POLICY "Ads are viewable by everyone."
ON public.ads FOR SELECT
USING (true); -- Cualquiera puede ver cualquier anuncio, el estado se maneja en la UI.

CREATE POLICY "Advertisers can insert their own ads."
ON public.ads FOR INSERT
TO authenticated
WITH CHECK (
  auth.uid() = user_id AND
  (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'ADVERTISER'
);

CREATE POLICY "Advertisers can update their own ads."
ON public.ads FOR UPDATE
TO authenticated
USING ((auth.uid() = user_id))
WITH CHECK ((auth.uid() = user_id));

CREATE POLICY "Advertisers can delete their own ads."
ON public.ads FOR DELETE
TO authenticated
USING (auth.uid() = user_id);

-- --- Tabla AD_MEDIA ---
ALTER TABLE public.ad_media ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Ad media is viewable by everyone." ON public.ad_media;
DROP POLICY IF EXISTS "Advertisers can insert media for their own ads." ON public.ad_media;
DROP POLICY IF EXISTS "Advertisers can delete media from their own ads." ON public.ad_media;

CREATE POLICY "Ad media is viewable by everyone."
ON public.ad_media FOR SELECT USING (true);

CREATE POLICY "Advertisers can insert media for their own ads."
ON public.ad_media FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Advertisers can delete media from their own ads."
ON public.ad_media FOR DELETE
TO authenticated
USING (auth.uid() = user_id);

-- --- Tabla AD_RATINGS ---
ALTER TABLE public.ad_ratings ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Ratings are viewable by everyone." ON public.ad_ratings;
DROP POLICY IF EXISTS "Users can insert or update their own rating." ON public.ad_ratings;
DROP POLICY IF EXISTS "Users cannot rate their own ads." ON public.ad_ratings;

CREATE POLICY "Ratings are viewable by everyone."
ON public.ad_ratings FOR SELECT
USING (true);

CREATE POLICY "Users can insert or update their own rating."
ON public.ad_ratings FOR ALL -- INSERT y UPDATE
TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (
  auth.uid() = user_id AND
  -- Evitar que califiquen su propio anuncio
  (SELECT user_id FROM public.ads WHERE id = ad_id) <> auth.uid()
);

-- --- Tabla AD_COMMENTS ---
ALTER TABLE public.ad_comments ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Approved comments are viewable by everyone." ON public.ad_comments;
DROP POLICY IF EXISTS "Users can view their own pending/rejected comments." ON public.ad_comments;
DROP POLICY IF EXISTS "Advertisers can view all comments on their ads." ON public.ad_comments;
DROP POLICY IF EXISTS "Users can insert comments." ON public.ad_comments;
DROP POLICY IF EXISTS "Users can delete their own comments." ON public.ad_comments;
DROP POLICY IF EXISTS "Advertisers can moderate comments on their ads." ON public.ad_comments;

CREATE POLICY "Approved comments are viewable by everyone."
ON public.ad_comments FOR SELECT
USING (status = 'approved');

CREATE POLICY "Users can view their own pending/rejected comments."
ON public.ad_comments FOR SELECT
TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "Advertisers can view all comments on their ads."
ON public.ad_comments FOR SELECT
TO authenticated
USING ((SELECT user_id FROM public.ads WHERE id = ad_comments.ad_id) = auth.uid());

CREATE POLICY "Users can insert comments."
ON public.ad_comments FOR INSERT
TO authenticated
WITH CHECK (
  auth.uid() = user_id AND
  -- Evitar que comenten su propio anuncio
  (SELECT user_id FROM public.ads WHERE id = ad_id) <> auth.uid()
);

CREATE POLICY "Users can delete their own comments."
ON public.ad_comments FOR DELETE
TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "Advertisers can moderate comments on their ads."
ON public.ad_comments FOR UPDATE -- Solo para cambiar el 'status'
TO authenticated
USING ((SELECT user_id FROM public.ads WHERE id = ad_comments.ad_id) = auth.uid())
WITH CHECK ((SELECT user_id FROM public.ads WHERE id = ad_comments.ad_id) = auth.uid());


-- =================================================================
-- POLÍTICAS DE ACCESO AL ALMACENAMIENTO (STORAGE)
-- =================================================================

-- --- Bucket AVATARS ---
DROP POLICY IF EXISTS "Avatar images are publicly accessible." ON storage.objects;
DROP POLICY IF EXISTS "Anyone can upload an avatar." ON storage.objects;
DROP POLICY IF EXISTS "Anyone can update their own avatar." ON storage.objects;

CREATE POLICY "Avatar images are publicly accessible."
ON storage.objects FOR SELECT
USING (bucket_id = 'avatars');

CREATE POLICY "Anyone can upload an avatar."
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'avatars' AND (storage.foldername(name))[1] = auth.uid()::text);

CREATE POLICY "Anyone can update their own avatar."
ON storage.objects FOR UPDATE
TO authenticated
USING (bucket_id = 'avatars' AND (storage.foldername(name))[1] = auth.uid()::text);


-- --- Bucket AD_MEDIA ---
DROP POLICY IF EXISTS "Ad media is publicly accessible." ON storage.objects;
DROP POLICY IF EXISTS "Advertisers can upload media." ON storage.objects;
DROP POLICY IF EXISTS "Advertisers can delete their own media." ON storage.objects;

CREATE POLICY "Ad media is publicly accessible."
ON storage.objects FOR SELECT
USING (bucket_id = 'ad_media');

CREATE POLICY "Advertisers can upload media."
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'ad_media' AND
  (storage.foldername(name))[1] = auth.uid()::text AND
  (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'ADVERTISER'
);

CREATE POLICY "Advertisers can delete their own media."
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'ad_media' AND (storage.foldername(name))[1] = auth.uid()::text);
